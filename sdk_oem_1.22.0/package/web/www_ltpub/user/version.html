<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <meta name="Keywords" content="">
        <meta name="Description" content="">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>路由设置</title>
        <link rel="stylesheet" href="../css/base.css">
        <link rel="stylesheet" href="../css/router.css">
        <link rel="stylesheet" href="../css/jquery.mCustomScrollbar.css">
        <script type="text/javascript" src="../js/jquery.js"></script>
        <script type="text/javascript" src="../js/jquery.cookie.js"></script> 
        <script language="javascript" type="text/javascript" src="../js/common.js"></script>
        <script type="text/javascript" src="../js/layer/layer.js"></script>
        <script type="text/javascript" src="../js/user.js"></script>
        <script>
            if ($.cookie('lstatus') != 'true') {
                $.cookie('lstatus', false, {path: '/'});
                document.location = 'http://' + document.domain + "/index.html?tt=" + new Date().getTime();
            }
        </script>        
        <!--[if IE 6]>
            <script type="text/javascript" src="../js/DD_belatedPNG.min.js"></script>
            <script type="text/javascript">
            DD_belatedPNG.fix("img,.png_ie");
            </script>
        <![endif]-->
        <!--[if IE 7]>
            <script src="../js/respond.min.js"></script>
        <![endif]-->
        <!--[if IE 8]>
            <script src="../js/respond.min.js"></script>
        <![endif]-->
    </head>
    <style type="text/css">
        .bgBar{
            background: #FFFFFF;
            font-family: Arial,Verdana;
            border: 1px solid #000000;
            text-align: left;
            font-size: 17;
            font-weight: bold;
        }
        .bgBar div{
            background: #DAECC8;
            border: 1px solid #FFFFFF;
            color:  #308040;
            text-align: right;
            overflow: hidden;
        }
    </style>        
    <script type="text/javascript">
        var interval = 0;
        var timeout = 0;
        var timeoutCount = 30;
        var isGet = false;

        var ProgressBar = {
            maxValue: 100,
            value: 0,
            SetValue: function (aValue) {
                this.value = aValue;
                if (this.value >= this.maxValue)
                    this.value = this.maxValue;
                if (this.value <= 0)
                    this.value = 0;
                var mWidth = this.value / this.maxValue * $("#progressBar_do").width() + "px";
                $("#progressBar_Track").css("width", mWidth);
                $("#progressBarTxt").html(this.value + "%");
            }
        }

        function checkVersion() {
            $.ajax({
                type: "POST",
                url: actionUrl,
                data: "fname=system&opt=firmstatus&function=get",
                dataType: "JSON",
                success: function (data) {
                    var jsonObject = data;
                    if (jsonObject.error == 0) {
                        $("#version").text('当前固件版本：' + jsonObject.localfirm_version);
                        if (jsonObject.status == 0) {
                            $("#update_1").val('最新固件');
                        } else if (jsonObject.status == 1) {
                            $("#update_1").val('下载固件');
                            $("#update_1").attr('onclick', 'getGradeStatus()');
                        } else if (jsonObject.status == 2) {
                            $("#update_1").val('正在下载');
                            $("#update_1").attr('disabled', true);
                        } else if (jsonObject.status == 3) {
                            $("#update_1").attr('disabled', false);
                            $("#update_1").val('升级固件');
                            $("#update_1").attr('onclick', 'up_Wrap()');
                        } else if (jsonObject.status == 4) {
                            layer.alert('升级失败！');
                        }
                    } else {
                        locationUrl(jsonObject.error);
                    }
                }
            });
        }

        function getGradeStatus() {
            $("#update_1").val('正在下载');
            $("#update_1").attr('disabled', true);
            $.ajax({
                type: "POST",
                url: actionUrl,
                data: "fname=system&opt=firmstatus&function=set&flag=get",
                dataType: "JSON",
                success: function (doStatus) {
                    if (doStatus.error == 0) {
                        layer.open({
                            type: 1,
                            title: false,
                            shade: [0.7, '#000'],
                            closeBtn: false,
                            content: $("#uploadLay"),
                            skin: 'cy-class'
                        });
//                        设置最大值
                        ProgressBar.maxValue = 100;
//                        设置当前刻度
                        var index = 0;
                        var mProgressTimer = window.setInterval(function () {
                            $.ajax({
                                type: "POST",
                                url: actionUrl,
                                data: "fname=system&opt=firmstatus&function=get",
                                dataType: "JSON",
                                success: function (jsonDoad) {
                                    if (jsonDoad.error == 0) {
                                        index = ((jsonDoad.curl / jsonDoad.total) * 100).toFixed(2);
                                        ProgressBar.SetValue(index);
                                        if (index == 100) {
                                            window.clearInterval(mProgressTimer);
                                            ProgressBar.SetValue(0);
                                            layer.closeAll();
                                            $("#update_1").val('升级固件');
                                            $("#update_1").attr('disabled', false);
                                            $("#update_1").attr('onclick', 'up_Wrap()');
                                        }
                                    }
                                }
                            });
                        }, 1000);
                    }
                }
            });
        }

        function up_Wrap() {
            $.ajax({
                type: "POST",
                url: actionUrl,
                data: "fname=system&opt=firmup&function=set",
                dataType: "JSON",
                success: function (data) {
                    var jsonObject = data;
                    if (jsonObject.error == 0) {
                        $("#update_1").val("正在升级...");
                        $("#update_1").attr('disabled', true);
                        $("#getMsg").show().text("正在升级，可能需要三分钟。升级过程中请勿操作或断电,升级完成后会自动进入详情页。");
                        var sec = 180;
                        setInterval(function () {
                            sec--;
                            if (sec == 0) {
                                document.location = 'index.html';
                            }
                        }, 1000);
                    } else {
                        layer.alert('升级失败！');
                    }
                }
            });
        }


        function setUpgrade() {
            $.ajax({
                type: "POST",
                url: actionUrl,
                data: "fname=system&opt=local_firmup&function=set",
                async: false,
                dataType: "json",
                success: function (data) {
                    var jsonObject = data;
                    if (jsonObject.error == 0) {
                        document.getElementById("_submit").value = "升级中...";
                        document.getElementById("_submit").disabled = true;
                        document.getElementById("msg").innerHTML = "正在升级，大约需要3分钟，请稍候...";
                        initBar();
                    } else {
                        document.getElementById("_submit").value = "升级出错";
                        document.getElementById("_submit").disabled = true;
                        document.getElementById("msg").innerHTML = "升级遇到错误，请联系触云客服！错误码：" + jsonObject.error;
                    }
                }
            });
        }

        function uploadFile() {

            /*var ifr = document.createElement("iframe");
             ifr.setAttribute("id", "hiddenFrame");
             ifr.setAttribute("name", "hiddenFrame");
             ifr.setAttribute("width",0);
             ifr.setAttribute("height",0);
             document.body.appendChild(ifr);*/

            if (document.getElementById("file").value == "") {
                document.getElementById("msg").innerHTML = "请先选择升级文件！";
            } else {
                if (document.getElementById("file").value.indexOf("firmware.bin") == -1) {
                    document.getElementById("msg").innerHTML = "固件文件名错误！应为：firmware.bin";
                } else {
                    stopAuto();
                    document.getElementById("_submit").value = "上传中...";
                    document.getElementById("_submit").disabled = true;
                    document.getElementById("msg").innerHTML = "正在上传，请稍候...";
                    document.getElementById("form1").action = "/upload.csp?uploadpath=/tmp/ioos&t=firmware.bin";
                    document.getElementById("form1").submit();
                    interval = setInterval(function () {
                        if (timeout > timeoutCount - 1) {
                            timeout = 0;
                            clearInterval(interval);
                            document.getElementById("msg").innerHTML = "超时，上传失败！";
                            document.getElementById("_submit").value = "确认上传";
                            document.getElementById("_submit").disabled = false;
                        }
                        if (!isGet) {
                            getResponseTimer();
                            timeout++;
                        }
                    }, 4000);
                }
            }
        }


        function getResponseTimer() {
            $.ajax({
                type: "POST",
                url: actionUrl,
                data: "fname=net&opt=upload_status&function=get",
                dataType: "json",
                success: function (data) {
                    var jsonObject = data;
                    if (jsonObject.error == 0) {
                        if (jsonObject.status == 1) {
                            clearInterval(interval);
                            isGet = true;
                            timeout = 0;
                            setUpgrade();
                        }
                    } else {
                        locationUrl(jsonObject.error);
                    }
                }
            });
        }

        var barWidth = 300;
        var barTimer = 500;
        if (syj == null)
            var syj = {};
        syj.ProgressBar = function (parent, width, barClass, display) {
            this.parent = parent;
            this.pixels = width;
            this.parent.innerHTML = "<div/>";
            this.outerDIV = this.parent.childNodes[0];
            this.outerDIV.innerHTML = "<div/>";
            this.fillDIV = this.outerDIV.childNodes[0];
            this.fillDIV.innerHTML = "0";
            this.fillDIV.style.width = "0px";
            this.outerDIV.className = barClass;
            this.outerDIV.style.width = (width + 2) + "px";
            this.parent.style.display = display == false ? 'none' : 'block';
        }

        syj.ProgressBar.prototype.setPercent = function (pct) {
            var fillPixels;
            if (pct < 0.99) {
                fillPixels = this.pixels * pct;
            } else {
                pct = 1.0;
                fillPixels = this.pixels;
                stopAuto();
                document.getElementById("_submit").value = "确认上传";
                document.getElementById("_submit").disabled = true;
                document.getElementById("msg").innerHTML = "升级完成，3秒后自动转入登陆页面";
                jtProBar.display(false);
                setTimeout("toLogin()", 4000);
            }
            this.fillDIV.innerHTML = (100 * pct).toFixed(0) + "%";
            this.fillDIV.style.width = fillPixels + "px";
        }

        syj.ProgressBar.prototype.display = function (v) {
            this.parent.style.display = v == true ? 'block' : 'none';
        }

        //初始化进度条
        function initBar() {
            window.jtProBar = new syj.ProgressBar(document.getElementById("progressBar"), barWidth, "bgBar");
            jtProBar.display(true);
            startAuto();
        }

        function startAuto() {
            if (window.thread == null)
                window.thread = window.setInterval("updatePercent()", barTimer);
        }

        function stopAuto() {
            window.clearInterval(window.thread);
            window.thread = null;
        }

        function updatePercent() {
            if (window.count == null)
                window.count = 0;
            window.count = count % barWidth;
            jtProBar.setPercent(window.count / barWidth);
            window.count++;
        }

        function toLogin() {
            $.cookie('lstatus', false, {path: '/'});
            document.location = "index.html?tt=" + new Date().getTime();
        }
    </script>

    <body>
        <div class="top">
            <a href="index.html" class="logo-box"><img src="../images/logo.png" width="166"></a>
        </div>
        <div class="menu">
            <a>我的路由<i class="png_ie i-1"></i></a>
            <a>网络设置<i class="png_ie i-2"></i></a>
            <a>无线设置<i class="png_ie i-5"></i></a>
            <a class="selected">固件升级<i class="png_ie i-4"></i></a>
        </div>
        <div class="wrap versionWrap">
            <div class="bg-img"><img src="../images/ver_bg.png"></div>
            <div class="ver-box">
                <h1 id="version">获取中...</h1>
                <p><input type="button" class="btn upload-btn" id="update_1" value="检查更新"></p>
                <div><em id="getMsg" style="color:yellow;display: none"></em></div>
                <div class="upload-box">
                    <h2>手动上传固件升级</h2>
                    <p>请选择固件</p>
                    <form name="form1" id="form1" enctype="multipart/form-data" method="post" action="" target="hiddenFrame">                    <div class="upload">
                            <div class="line"> 
                                <span class="span"><input name="" type="text" id="viewfile" onMouseOut="document.getElementById('file').style.display = 'none';" class="inputstyle" /> </span> 
                                <label for="unload" onMouseOver="document.getElementById('file').style.display = 'block';" class="file1">选择</label> 
                                <input class="file"onchange="document.getElementById('viewfile').value = this.value;
                                        this.style.display = 'none';" name="file" id="file" type="file" value="" />
                            </div> 
                        </div>           
                        <input class="btn upload-btn" name="_submit" id="_submit" type="submit" value="确认上传" onClick="javascript:uploadFile();">
                        <div><em id="msg" style="color:yellow;"></em></div>
                        <div name="progressBar" id="progressBar" style="display:none"></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 上传更新固件 -->
        <div class="wifiConnectLayer" id="uploadLay">
            <div class="bg"></div>
            <div class="con">
                <p>爱路由固件下载</p>
                <div id="progressBar_do">
                    <div id="progressBar_Track"></div>
                </div>
                <p id="progressBarTxt"></p>
                <p>正在下载中，请稍候</p>
            </div>
        </div>
        <!-- 上传更新固件 end-->
    </body>
</html>
<script type="text/javascript">
    checkVersion();
</script>
<iframe name="hiddenFrame" id="hiddenFrame" width="0" height="0"/>